<!DOCTYPE html>
<html lang="en">
<head>
	<title>Ponce Points</title>
	<meta charset="UTF-8">
	<script src="../common/scores.js"></script>
	<link href="css/index.css" rel="stylesheet"/>
</head>
<body>
<div>
	<div class="bar">
		<div class="leftPart">
			<div class="raceNumber background" id="raceNumber">
				<span class="legend">Course</span>
				<span class="currentRace" id="currentRace">0</span>
				<span class="maxRaces">24</span>
			</div>
		</div>
		<div class="middlePart">
			<div class="points background" id="points">
				<div class="record" id="record">
					<span class="legend">Record</span>
					<span class="score" id="recordScore">0</span>
					<span class="delta" id="recordDelta">0</span>
				</div>
				<div class="current" id="current">
					<span class="legend">Session</span>
					<span class="score" id="currentScore">0</span>
				</div>
				<div class="worst" id="worst">
					<span class="legend">Pire</span>
					<span class="score" id="worstScore">0</span>
					<span class="delta" id="worstDelta">0</span>
				</div>
			</div>
			<div id="races">
				<div class="raceResult current" data-number="1"></div>
				<div class="raceResult" data-number="2"></div>
				<div class="raceResult" data-number="3"></div>
				<div class="raceResult" data-number="4"></div>
				<div class="raceResult" data-number="5"></div>
				<div class="raceResult" data-number="6"></div>
				<div class="raceResult" data-number="7"></div>
				<div class="raceResult" data-number="8"></div>
				<div class="raceResult" data-number="9"></div>
				<div class="raceResult" data-number="10"></div>
				<div class="raceResult" data-number="11"></div>
				<div class="raceResult" data-number="12"></div>
				<div class="raceResult" data-number="13"></div>
				<div class="raceResult" data-number="14"></div>
				<div class="raceResult" data-number="15"></div>
				<div class="raceResult" data-number="16"></div>
				<div class="raceResult" data-number="17"></div>
				<div class="raceResult" data-number="18"></div>
				<div class="raceResult" data-number="19"></div>
				<div class="raceResult" data-number="20"></div>
				<div class="raceResult" data-number="21"></div>
				<div class="raceResult" data-number="22"></div>
				<div class="raceResult" data-number="23"></div>
				<div class="raceResult" data-number="24"></div>
			</div>
		</div>
		<div class="rightPart">
			<div class="topPart background">
				<div class="objective" id="objective">
					<span class="legend">Objectif</span>
					<span class="score" id="objectiveScore">200</span>
					<span class="delta" id="objectiveDelta">0</span>
				</div>
				<img alt="logo"
					 height="35px"
					 src="https://static-cdn.jtvnw.net/jtv_user_pictures/72dae8da-582a-4a2b-a234-37d4cd3fa7d9-profile_image-70x70.png"
					 style="border-radius: 50%; opacity: 0.8; margin-left: auto;"/>
			</div>
			<div class="background" id="miscInfo">
				<div id="tournamentName">Ave - 107</div>
				<div id="playerName">Matias49</div>
				<div id="hour"></div>
			</div>
		</div>


	</div>
</div>
<script src="js/anime.min.js" type="text/javascript"></script>
<script>
	let recordScoreNumber = 0;

	let currentRankings = [];
	let currentCumulativePoints = [];

	let recordScore = document.getElementById('recordScore');
	let recordDelta = document.getElementById('recordDelta');

	let currentRace = document.getElementById('currentRace');
	let currentScore = document.getElementById('currentScore');

	let worstScore = document.getElementById('worstScore');
	let worstDelta = document.getElementById('worstDelta');

	let objectiveScore = document.getElementById('objectiveScore');
	let objectiveDelta = document.getElementById('objectiveDelta');

	document.addEventListener("DOMContentLoaded", () => {
		objectiveScore.textContent = objectiveScoreNumber;
		updateObjectiveDelta();
	});

	function updateRaceResultsBar() {
		let result;
		let previousRaceResult = document.querySelector('.raceResult[data-number="' + currentRankings.length + '"]');
		previousRaceResult.classList.remove('current');
		previousRaceResult.classList.add('past');
		switch (currentRankings[currentRankings.length - 1]) {
			case 1:
				result = 'ðŸ¥‡';
				previousRaceResult.classList.add('first');
				break;
			case 2:
				result = 'ðŸ¥ˆ';
				previousRaceResult.classList.add('second');
				break;
			case 3:
				result = 'ðŸ¥‰';
				previousRaceResult.classList.add('third');
				break;
			default:
				result = currentRankings[currentRankings.length - 1];
				break;
		}
		// currentRankings.forEach((value, index) => {
		// 	let raceResult = document.querySelector('.raceResult[data-number="' + ++index + '"]');
		// 	raceResult.classList.remove('current');
		// 	raceResult.classList.add('past');
		// 	let result;
		// 	raceResult.textContent = value;
		//
		// });
		if (isNaN(result)) {
			// previousRaceResult.style.opacity = 0.9
			// anime({
			// 	targets: previousRaceResult,
			// 	opacity: 1,
			// 	easing: 'linear',
			// 	duration: 1000,
			// });
			previousRaceResult.textContent = result;
		} else {
			anime({
				targets: previousRaceResult,
				textContent: [12, result],
				easing: 'linear',
				round: 1,
				duration: 500,
			});
		}

		let currentRace = document.querySelector('.raceResult[data-number="' + (currentRankings.length + 1) + '"]');
		currentRace.classList.add('current')
	}

	nodecg.listenFor('raceRanking', ranking => {
		// console.log(ranking);
		currentRankings.push(ranking);
		let previousPoints = isNaN(currentCumulativePoints[currentCumulativePoints.length - 1]) ? 0 : currentCumulativePoints[currentCumulativePoints.length - 1];
		currentCumulativePoints.push(previousPoints + calcPoints(ranking))
		currentRace.textContent = currentRankings.length;
		// worstScore.textContent = worstCumulativePoints[currentRankings.length - 1];
		// currentScore.textContent = currentCumulativePoints[currentRankings.length - 1];
		// displayNewDeltas();
		updateRaceResultsBar();
		updateScoreData();
		updateRecordData();
		updateWorstData();
		updateObjectiveDelta();
	});

	function updateScoreData() {
		anime({
			targets: currentScore,
			keyframes: [{opacity: 0}, {opacity: 1}],
			easing: 'linear',
			duration: 1000,
		});
		anime({
			targets: currentScore,
			textContent: [currentScore.textContent, currentCumulativePoints[currentRankings.length - 1]],
			easing: 'easeInOutSine',
			round: 1,
			duration: 500,
			delay: 250,
		});


	}

	function updateRecordData() {
		anime({
			targets: recordScore,
			keyframes: [{opacity: 0}, {opacity: 1}],
			easing: 'linear',
			duration: 1000,
		});
		anime({
			targets: recordScore,
			textContent: [recordScore.textContent, recordCumulativePoints[currentRankings.length - 1]],
			easing: 'easeInOutSine',
			round: 1,
			duration: 500,
			delay: 250,
		});

		let delta = getCurrentDeltaValue(recordCumulativePoints[currentRankings.length - 1]);
		// anime({
		// 	targets: worstDelta,
		// 	keyframes: [{opacity: 0}, {opacity: 1}],
		// 	easing: 'linear',
		// 	duration: 1000,
		// });
		anime({
			targets: recordDelta,
			textContent: [recordDelta.textContent, delta],
			easing: 'easeInOutSine',
			color: getDeltaColor(delta),
			round: 1,
			duration: 500,
			delay: 150,
		}).finished.then(function () {
			if (delta > 0) {
				recordDelta.classList.add('positive');
			} else {
				recordDelta.classList.remove('positive');
			}
		});
	}

	function updateWorstData() {
		anime({
			targets: worstScore,
			keyframes: [{opacity: 0}, {opacity: 1}],
			easing: 'linear',
			duration: 1000,
		});
		anime({
			targets: worstScore,
			textContent: [worstScore.textContent, worstCumulativePoints[currentRankings.length - 1]],
			easing: 'easeInOutSine',
			round: 1,
			duration: 500,
			delay: 150,
		});

		let delta = getCurrentDeltaValue(worstCumulativePoints[currentRankings.length - 1]);
		// anime({
		// 	targets: worstDelta,
		// 	keyframes: [{opacity: 0}, {opacity: 1}],
		// 	easing: 'linear',
		// 	duration: 1000,
		// });
		anime({
			targets: worstDelta,
			textContent: [worstDelta.textContent, delta],
			easing: 'easeInOutSine',
			color: getDeltaColor(delta),
			round: 1,
			duration: 500,
			delay: 150,
		}).finished.then(function () {
			if (delta > 0) {
				worstDelta.classList.add('positive');
			} else {
				worstDelta.classList.remove('positive');
			}
		});


	}

	function updateObjectiveDelta() {
		let delta = getCurrentDeltaValue(objectiveScore.textContent);
		anime({
			targets: objectiveDelta,
			textContent: [objectiveDelta.textContent, delta],
			easing: 'easeInOutSine',
			color: getDeltaColor(delta),
			round: 1,
			duration: 500,
			delay: 250,
		}).finished.then(function () {
			if (delta > 0) {
				objectiveDelta.classList.add('positive');
			} else {
				objectiveDelta.classList.remove('positive');
			}
		});
	}

	function getCurrentDeltaValue(value) {
		let currentValue = isNaN(currentCumulativePoints[currentRankings.length - 1]) ? 0 : currentCumulativePoints[currentRankings.length - 1];
		return value - currentValue;
	}

	function getDeltaColor(delta) {
		if (delta < 0) {
			return '#a8ff56';
		} else if (delta > 0) {
			return '#fcff56';
		} else {
			return '#fff';
		}
	}

	// function displayNewDeltas() {
	// 	let recordDeltaCalc = recordScore.textContent - currentScore.textContent;
	// 	let worstDeltaCalc = worstScore.textContent - currentScore.textContent;
	// 	let objectiveDeltaCalc = objectiveScore.textContent - currentScore.textContent;
	//
	// 	recordDelta.textContent = recordDeltaCalc;
	// 	worstDelta.textContent = worstDeltaCalc;
	// 	objectiveDelta.textContent = objectiveDeltaCalc;
	//
	// 	let deltas = [worstDelta, objectiveDelta, recordDelta];
	// 	deltas.forEach((delta) => {
	// 		if (delta.textContent < 0) {
	// 			delta.style.color = '#a8ff56';
	// 		} else if (delta.textContent > 0) {
	// 			delta.textContent = '+' + delta.textContent;
	// 			delta.style.color = '#fcff56';
	// 		} else {
	// 			delta.style.color = '#fff';
	// 		}
	// 	});
	//
	// }

	// You can access the NodeCG api anytime from the `window.nodecg` object
	// Or just `nodecg` for short. Like this!:
	nodecg.log.info('Here\'s an example of using NodeCG\'s logging API!');

	//region hour
	let dateTime = new Date();

	function updateTime() {
		dateTime = new Date();
		// https://stackoverflow.com/questions/10211145/getting-current-date-and-time-in-javascript
		var hour = dateTime.getHours();
		var minute = dateTime.getMinutes();
		if (hour.toString().length === 1) {
			hour = '0' + hour;
		}
		if (minute.toString().length === 1) {
			minute = '0' + minute;
		}
		document.getElementById('hour').textContent = hour + ":" + minute;

	}

	setInterval(function () {
		updateTime();
	}, 1000);
	//endregion
</script>
</body>
</html>
